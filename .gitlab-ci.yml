stages:
  - build
  - deploy

variables:
  DOCKER_COMPOSE_FILE: docker-compose.prod.yml  # –£–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—à prod-—Ñ–∞–π–ª
  CI_REGISTRY_IMAGE: registry.gitlab.com/yo3395005/yofun  # –ü—É—Ç—å –∫ –≤–∞—à–µ–º—É Container Registry

# üîπ –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ —á–µ—Ä–µ–∑ docker-compose
build:
  stage: build
  image: docker:24.0
  services:
    - docker:24.0-dind  # Docker-in-Docker –¥–ª—è —Å–±–æ—Ä–∫–∏
  rules:
    - if: $CI_COMMIT_BRANCH == "master"  # –¢–æ–ª—å–∫–æ –¥–ª—è main-–≤–µ—Ç–∫–∏
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker compose -f $DOCKER_COMPOSE_FILE build
    - docker compose -f $DOCKER_COMPOSE_FILE push  # –ü—É—à–∏–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ Registry

# üîπ –î–µ–ø–ª–æ–π –Ω–∞ VPS (—á–µ—Ä–µ–∑ docker-compose)
deploy:
  stage: deploy
  image: alpine:3.18
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
  before_script:
    - apk add --no-cache openssh-client docker-cli  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH –∏ Docker CLI
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -  # –î–æ–±–∞–≤–ª—è–µ–º SSH-–∫–ª—é—á
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $VPS_IP >> ~/.ssh/known_hosts  # –î–æ–±–∞–≤–ª—è–µ–º VPS –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ
  script:
    - scp $DOCKER_COMPOSE_FILE $VPS_USER@$VPS_IP:/app/  # –ö–æ–ø–∏—Ä—É–µ–º docker-compose.prod.yml –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    - ssh $VPS_USER@$VPS_IP "
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
        cd /app &&
        docker compose -f $DOCKER_COMPOSE_FILE pull &&  # –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
        docker compose -f $DOCKER_COMPOSE_FILE down &&   # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
        docker compose -f $DOCKER_COMPOSE_FILE up -d    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ
      "
